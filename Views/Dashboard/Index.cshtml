@model DashboardViewModel

<div class="container-fluid">
    <!-- Dashboard Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h1 class="page-title mb-1">📊 Dashboard Overview</h1>
            <p class="text-muted mb-0">Real-time insights into your inventory and sales performance</p>
        </div>
        <div class="d-flex gap-2">
            <button class="btn btn-outline-primary btn-modern" onclick="refreshDashboard()">
                <i class="fas fa-sync-alt me-2"></i>Refresh
            </button>
            <span id="connectionStatus" class="badge bg-success d-flex align-items-center">
                <i class="fas fa-circle me-1" style="font-size: 0.5rem;"></i>
                Live
            </span>
        </div>
    </div>

    <!-- Real-time notifications -->
    <div id="notifications"></div>

    <!-- Key Metrics Grid -->
    <div class="row g-4 mb-4">
        <div class="col-xl-2 col-md-4 col-6">
            <div class="metric-card">
                <div class="metric-icon">
                    <i class="fas fa-boxes"></i>
                </div>
                <div class="metric-value">@Model.TotalProducts</div>
                <div class="metric-label">Total Products</div>
            </div>
        </div>
        <div class="col-xl-2 col-md-4 col-6">
            <div class="metric-card">
                <div class="metric-icon" style="background: rgba(16, 185, 129, 0.1); color: var(--success);">
                    <i class="fas fa-shopping-cart"></i>
                </div>
                <div class="metric-value" id="totalOrders">@Model.TotalOrders</div>
                <div class="metric-label">Total Orders</div>
            </div>
        </div>
        <div class="col-xl-2 col-md-4 col-6">
            <div class="metric-card">
                <div class="metric-icon" style="background: rgba(99, 102, 241, 0.1); color: var(--primary);">
                    <i class="fas fa-chart-line"></i>
                </div>
                <div class="metric-value" id="totalRevenue">@Model.TotalRevenue.ToString("C")</div>
                <div class="metric-label">Total Revenue</div>
            </div>
        </div>
        <div class="col-xl-2 col-md-4 col-6">
            <div class="metric-card">
                <div class="metric-icon" style="background: rgba(245, 158, 11, 0.1); color: var(--warning);">
                    <i class="fas fa-coins"></i>
                </div>
                <div class="metric-value" id="totalProfit">@Model.TotalProfit.ToString("C")</div>
                <div class="metric-label">Total Profit</div>
            </div>
        </div>
        <div class="col-xl-2 col-md-4 col-6">
            <div class="metric-card">
                <div class="metric-icon" style="background: rgba(239, 68, 68, 0.1); color: var(--danger);">
                    <i class="fas fa-exclamation-triangle"></i>
                </div>
                <div class="metric-value" id="lowStockCount">@Model.CriticalStockCount</div>
                <div class="metric-label">Low Stock Items</div>
            </div>
        </div>
        <div class="col-xl-2 col-md-4 col-6">
            <div class="metric-card">
                <div class="metric-icon" style="background: rgba(100, 116, 139, 0.1); color: var(--secondary);">
                    <i class="fas fa-percentage"></i>
                </div>
                <div class="metric-value">
                    @((Model.TotalRevenue > 0 ? (Model.TotalProfit / Model.TotalRevenue) * 100 : 0).ToString("F1"))%
                </div>
                <div class="metric-label">Profit Margin</div>
            </div>
        </div>
    </div>

    <div class="row g-4">
        <!-- Low Stock Alerts -->
        <div class="col-xl-6">
            <div class="modern-card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">
                        <i class="fas fa-exclamation-triangle text-warning me-2"></i>
                        Low Stock Alerts
                        <span class="badge bg-warning ms-2" id="liveLowStockCount">@Model.LowStockProducts.Count</span>
                    </h5>
                    <a asp-controller="Products" asp-action="Index" class="btn btn-sm btn-outline-primary">
                        Manage Products
                    </a>
                </div>
                <div class="card-body">
                    <div id="lowStockList">
                        @await Html.PartialAsync("_LowStockList", Model.LowStockProducts)
                    </div>
                </div>
            </div>
        </div>

        <!-- Recent Orders -->
        <div class="col-xl-6">
            <div class="modern-card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">
                        <i class="fas fa-clock text-info me-2"></i>
                        Recent Orders
                        <span class="badge bg-info ms-2" id="liveRecentOrdersCount">@Model.RecentOrders.Count</span>
                    </h5>
                    <a asp-controller="Orders" asp-action="Index" class="btn btn-sm btn-outline-primary">
                        View All
                    </a>
                </div>
                <div class="card-body">
                    <div id="recentOrdersList">
                        @await Html.PartialAsync("_RecentOrdersList", Model.RecentOrders)
                    </div>
                </div>
            </div>
        </div>

        <!-- Quick Stats -->
        <div class="col-xl-6">
            <div class="modern-card">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-chart-pie text-success me-2"></i>
                        Inventory Health
                    </h5>
                </div>
                <div class="card-body">
                    <canvas id="inventoryHealthChart" height="250"></canvas>
                </div>
            </div>
        </div>

        <!-- Sales Trend -->
        <div class="col-xl-6">
            <div class="modern-card">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-trend-up text-primary me-2"></i>
                        Sales Trend (Last 7 Days)
                    </h5>
                </div>
                <div class="card-body">
                    <canvas id="salesTrendChart" height="250"></canvas>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        // Initialize Charts
        document.addEventListener('DOMContentLoaded', function() {
            initializeInventoryHealthChart();
            initializeSalesTrendChart();
            initializeRealTimeUpdates();
        });

        function initializeInventoryHealthChart() {
            const ctx = document.getElementById('inventoryHealthChart').getContext('2d');
            new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['In Stock', 'Low Stock', 'Out of Stock'],
                    datasets: [{
                        data: [@(Model.TotalProducts - Model.CriticalStockCount), @Model.CriticalStockCount, 0],
                        backgroundColor: [
                            '#10b981',
                            '#f59e0b',
                            '#ef4444'
                        ],
                        borderWidth: 2,
                        borderColor: 'var(--bg-primary)'
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                color: 'var(--text-primary)',
                                padding: 20
                            }
                        }
                    },
                    cutout: '70%'
                }
            });
        }

        function initializeSalesTrendChart() {
            const ctx = document.getElementById('salesTrendChart').getContext('2d');
            new Chart(ctx, {
                type: 'line',
                data: {
                    labels: ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'],
                    datasets: [{
                        label: 'Daily Revenue',
                        data: [1200, 1900, 1500, 2200, 1800, 2500, 2000],
                        borderColor: '#6366f1',
                        backgroundColor: 'rgba(99, 102, 241, 0.1)',
                        borderWidth: 3,
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            grid: {
                                color: 'var(--border-color)'
                            },
                            ticks: {
                                color: 'var(--text-secondary)',
                                callback: function(value) {
                                    return '$' + value;
                                }
                            }
                        },
                        x: {
                            grid: {
                                color: 'var(--border-color)'
                            },
                            ticks: {
                                color: 'var(--text-secondary)'
                            }
                        }
                    }
                }
            });
        }

        function initializeRealTimeUpdates() {
            const connection = new signalR.HubConnectionBuilder()
                .withUrl("/dashboardHub")
                .build();

            connection.start().then(() => {
                console.log("SignalR Connected");
                document.getElementById('connectionStatus').className = 'badge bg-success d-flex align-items-center';
            }).catch(err => {
                console.error("SignalR Connection Failed: ", err);
                document.getElementById('connectionStatus').className = 'badge bg-danger d-flex align-items-center';
            });

            // Handle real-time updates
            connection.on("ReceiveNewOrderAlert", (customerName, orderTotal) => {
                UI.showNotification(`New order from ${customerName} for ${UI.formatCurrency(orderTotal)}`, 'success');

                // Update metrics
                const totalOrdersElem = document.getElementById('totalOrders');
                totalOrdersElem.textContent = parseInt(totalOrdersElem.textContent) + 1;

                const totalRevenueElem = document.getElementById('totalRevenue');
                const currentRevenue = parseFloat(totalRevenueElem.textContent.replace(/[^0-9.-]+/g,""));
                totalRevenueElem.textContent = UI.formatCurrency(currentRevenue + orderTotal);
            });

            connection.on("ReceiveLowStockAlert", (productName, currentStock, reorderLevel) => {
                UI.showNotification(`Low stock: ${productName} (${currentStock} left)`, 'warning');

                const lowStockCountElem = document.getElementById('lowStockCount');
                lowStockCountElem.textContent = parseInt(lowStockCountElem.textContent) + 1;
            });
        }

        function refreshDashboard() {
            UI.showNotification('Refreshing dashboard data...', 'info');
            setTimeout(() => {
                window.location.reload();
            }, 1000);
        }
    </script>
}