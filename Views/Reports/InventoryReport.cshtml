@model InventoryReportViewModel

@{
    ViewData["Title"] = "Inventory Report";
}

<div class="container-fluid">
    <h2>📦 Inventory Valuation Report</h2>

    <!-- Filters -->
    <div class="card mb-4">
        <div class="card-body">
            <form method="get" class="row g-3">
                <div class="col-md-4">
                    <label for="category" class="form-label">Category</label>
                    <select name="category" class="form-select">
                        <option value="All">All Categories</option>
                        @foreach (var category in ViewBag.Categories)
                        {
                            <option value="@category" selected="@(ViewBag.SelectedCategory == category)">@category</option>
                        }
                    </select>
                </div>
                <div class="col-md-4">
                    <label for="stockStatus" class="form-label">Stock Status</label>
                    <select name="stockStatus" class="form-select">
                        <option value="">All Statuses</option>
                        <option value="InStock" selected="@(ViewBag.SelectedStockStatus == "InStock")">In Stock</option>
                        <option value="LowStock" selected="@(ViewBag.SelectedStockStatus == "LowStock")">Low Stock</option>
                        <option value="OutOfStock" selected="@(ViewBag.SelectedStockStatus == "OutOfStock")">Out of Stock</option>
                    </select>
                </div>
                <div class="col-md-4 d-flex align-items-end">
                    <button type="submit" class="btn btn-primary me-2">Apply Filters</button>
                    <a asp-action="InventoryReport" class="btn btn-outline-secondary">Clear</a>
                </div>
            </form>
        </div>
    </div>

    <!-- Summary Cards -->
    <div class="row mb-4">
        <div class="col-md-4">
            <div class="card text-white bg-primary">
                <div class="card-body">
                    <h5 class="card-title">Total Products</h5>
                    <p class="card-text display-6">@Model.Products.Count</p>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card text-white bg-warning">
                <div class="card-body">
                    <h5 class="card-title">Low Stock Items</h5>
                    <p class="card-text display-6">@Model.LowStockCount</p>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card text-white bg-danger">
                <div class="card-body">
                    <h5 class="card-title">Out of Stock</h5>
                    <p class="card-text display-6">@Model.OutOfStockCount</p>
                </div>
            </div>
        </div>
    </div>

    <div class="row mb-4">
        <div class="col-md-6">
            <div class="card text-white bg-success">
                <div class="card-body">
                    <h5 class="card-title">Total Inventory Value</h5>
                    <p class="card-text display-6">@Model.TotalStockValue.ToString("C")</p>
                    <small>Based on cost price × stock quantity</small>
                </div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="card bg-light">
                <div class="card-body text-center">
                    <h5 class="card-title">Export Options</h5>
                    <a asp-controller="Products" asp-action="ExportToExcel" class="btn btn-success">
                        📊 Export to Excel
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- Inventory Table -->
    <div class="card">
        <div class="card-header bg-info text-white">
            <h5 class="mb-0">Complete Inventory Listing</h5>
        </div>
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-striped table-hover">
                    <thead class="table-dark">
                        <tr>
                            <th>Image</th>
                            <th>Product</th>
                            <th>SKU</th>
                            <th>Category</th>
                            <th>Supplier</th>
                            <th>Cost Price</th>
                            <th>Selling Price</th>
                            <th>Stock Qty</th>
                            <th>Reorder Level</th>
                            <th>Stock Value</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var product in Model.Products)
                        {
                            var stockValue = product.StockQuantity * product.CostPrice;
                            var status = product.StockQuantity == 0 ? "Out of Stock" :
                            product.StockQuantity <= product.ReorderLevel ? "Low Stock" : "In Stock";
                            var statusClass = product.StockQuantity == 0 ? "danger" :
                            product.StockQuantity <= product.ReorderLevel ? "warning" : "success";

                            <tr>
                                <td>
                                    @if (!string.IsNullOrEmpty(product.ImageUrl))
                                    {
                                        <img src="@product.ImageUrl" alt="@product.Name"
                                             style="width: 40px; height: 40px; object-fit: cover;"
                                             class="img-thumbnail" />
                                    }
                                    else
                                    {
                                        <span class="text-muted">No Image</span>
                                    }
                                </td>
                                <td>
                                    <strong>@product.Name</strong>
                                    @if (!string.IsNullOrEmpty(product.Description))
                                    {
                                        <br />
                                        <small class="text-muted">@product.Description</small>
                                    }
                                </td>
                                <td>@product.SKU</td>
                                <td>@product.Category</td>
                                <td>@(product.Supplier?.Name ?? "No Supplier")</td>
                                <td>@product.CostPrice.ToString("C")</td>
                                <td>@product.Price.ToString("C")</td>
                                <td>
                                    <span class="@(product.StockQuantity <= product.ReorderLevel ? "fw-bold" : "")">
                                        @product.StockQuantity
                                    </span>
                                </td>
                                <td>@product.ReorderLevel</td>
                                <td class="fw-bold">@stockValue.ToString("C")</td>
                                <td>
                                    <span class="badge bg-@statusClass">@status</span>
                                </td>
                            </tr>
                        }
                    </tbody>
                    <tfoot class="table-secondary">
                        <tr>
                            <td colspan="9" class="text-end fw-bold">Total Inventory Value:</td>
                            <td class="fw-bold">@Model.TotalStockValue.ToString("C")</td>
                            <td></td>
                        </tr>
                    </tfoot>
                </table>
            </div>
        </div>
    </div>

    <!-- Stock Analysis -->
    <div class="row mt-4">
        <div class="col-md-6">
            <div class="card">
                <div class="card-header bg-warning text-dark">
                    <h5 class="mb-0">📊 Stock Level Analysis</h5>
                </div>
                <div class="card-body">
                    @{
                        var inStockCount = Model.Products.Count(p => p.StockQuantity > p.ReorderLevel);
                        var lowStockCount = Model.Products.Count(p => p.StockQuantity <= p.ReorderLevel && p.StockQuantity > 0);
                        var outOfStockCount = Model.Products.Count(p => p.StockQuantity == 0);
                        var totalProducts = Model.Products.Count;
                    }

                    <div class="mb-3">
                        <strong>In Stock:</strong>
                        <span class="badge bg-success">@inStockCount products</span>
                        <div class="progress mt-1">
                            <div class="progress-bar bg-success" style="width: @((inStockCount / (double)totalProducts) * 100)%">
                                @((inStockCount / (double)totalProducts * 100).ToString("F1"))%
                            </div>
                        </div>
                    </div>

                    <div class="mb-3">
                        <strong>Low Stock:</strong>
                        <span class="badge bg-warning">@lowStockCount products</span>
                        <div class="progress mt-1">
                            <div class="progress-bar bg-warning" style="width: @((lowStockCount / (double)totalProducts) * 100)%">
                                @((lowStockCount / (double)totalProducts * 100).ToString("F1"))%
                            </div>
                        </div>
                    </div>

                    <div class="mb-3">
                        <strong>Out of Stock:</strong>
                        <span class="badge bg-danger">@outOfStockCount products</span>
                        <div class="progress mt-1">
                            <div class="progress-bar bg-danger" style="width: @((outOfStockCount / (double)totalProducts) * 100)%">
                                @((outOfStockCount / (double)totalProducts * 100).ToString("F1"))%
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-md-6">
            <div class="card">
                <div class="card-header bg-info text-white">
                    <h5 class="mb-0">💰 Value Analysis</h5>
                </div>
                <div class="card-body">
                    @{
                        var inStockValue = Model.Products.Where(p => p.StockQuantity > p.ReorderLevel)
                        .Sum(p => p.StockQuantity * p.CostPrice);
                        var lowStockValue = Model.Products.Where(p => p.StockQuantity <= p.ReorderLevel && p.StockQuantity > 0)
                        .Sum(p => p.StockQuantity * p.CostPrice);
                        var outOfStockValue = Model.Products.Where(p => p.StockQuantity == 0)
                        .Sum(p => p.StockQuantity * p.CostPrice); // This will be 0, but included for completeness
                    }

                    <div class="mb-3">
                        <strong>In Stock Value:</strong>
                        <span class="fw-bold text-success">@inStockValue.ToString("C")</span>
                        <div class="progress mt-1">
                            <div class="progress-bar bg-success" style="width: @((inStockValue / Model.TotalStockValue) * 100)%">
                                @((inStockValue / Model.TotalStockValue * 100).ToString("F1"))%
                            </div>
                        </div>
                    </div>

                    <div class="mb-3">
                        <strong>Low Stock Value:</strong>
                        <span class="fw-bold text-warning">@lowStockValue.ToString("C")</span>
                        <div class="progress mt-1">
                            <div class="progress-bar bg-warning" style="width: @((lowStockValue / Model.TotalStockValue) * 100)%">
                                @((lowStockValue / Model.TotalStockValue * 100).ToString("F1"))%
                            </div>
                        </div>
                    </div>

                    <div class="mb-3">
                        <strong>Out of Stock Value:</strong>
                        <span class="fw-bold text-danger">@outOfStockValue.ToString("C")</span>
                        <div class="progress mt-1">
                            <div class="progress-bar bg-danger" style="width: @((outOfStockValue / Model.TotalStockValue) * 100)%">
                                @((outOfStockValue / Model.TotalStockValue * 100).ToString("F1"))%
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@section Styles {
    <style>
        .table th {
            background-color: #343a40;
            color: white;
        }

        .progress {
            height: 25px;
        }

        .progress-bar {
            font-weight: bold;
        }
    </style>
}